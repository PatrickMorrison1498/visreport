{% extends 'base.html' %}
{% block content %}
{% load static %}


{% load leaflet_tags %}

<head>
    {% leaflet_js %}
    {% leaflet_css %}

    <!-- style tag and django-leaflet tag here -->
    <style media="screen">
        #map { width:100%; height:100% }
        .leaflet-tooltip-pane .text {
        color: black; 
        font-weight: bold;
        background: transparent;
        border:0;
        box-shadow: none;
        font-size:1em;
}
      </style>



    <script src="{% static 'bower_components/leaflet-ajax/dist/leaflet.ajax.min.js' %}"></script>
    <script src="{% static 'bower_components/spin.js/spin.min.js' %}"></script>
    <script src="{% static 'bower_components/leaflet-spin/leaflet.spin.js' %}"></script>

</head>
<body>

    <script type="text/javascript">

    var vis = {}

    {%for site in sites.all%}
        vis["{{site.site_code}}"] = "{{site.current_vis}}";
    {%endfor%}


    function geojsonMarkerOptions(feature) {
        return {
        radius: 20,
        fillColor: getColor(vis[feature.properties.pk.toString()]),
        color: "#000",
        weight: 1,
        opacity: 1,
        fillOpacity: 1
                   
    };
    }

    function getColor(v) {
    console.log(v)
    return v > 20 ? '#0275d8' :
           v > 10 ? '#5cb85c' :
           v > 5  ? '#f0ad4e' :
                    '#d9534f' ;
    }

        function map_init_basic (map, options) {
              var geojsonSiteLayer = new L.GeoJSON.AJAX("{% url 'sites' %}", {
            pointToLayer: function (feature, latlng) {
             return L.circleMarker(latlng, geojsonMarkerOptions(feature));
         },
    onEachFeature: function(feature, layer) {

        var text = L.tooltip({
            permanent: true,
            direction: 'center',
            className: 'text'
        })
        .setContent(feature.properties.pk.toString())
        .setLatLng(layer.getLatLng());
        text.addTo(map);
        
        var text2 = L.tooltip({
            direction: 'auto',
            className: 'text2',
            sticky: true
        })
        .setContent(feature.properties.site_name.toString() + "Vis = "+ vis[feature.properties.pk.toString()])
        .setLatLng(layer.getLatLng());
        layer.bindTooltip(text2);
    
    }
}).addTo(map);
          }
     </script>
     
    {% leaflet_map "map" callback="window.map_init_basic" %}
</body>


{% endblock %}

