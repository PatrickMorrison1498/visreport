{% extends 'base.html' %}
{% block content %}
{% load static %}


{% load leaflet_tags %}

<head>
    {% leaflet_js %}
    {% leaflet_css %}

    <!-- style tag and django-leaflet tag here -->
    <style media="screen">
        #map { width:100%; height:100% }
        .leaflet-tooltip-pane .label {
        color: white; 
        font-weight: bolder;
        font-style: italic;
        background: transparent;
        border:0;
        box-shadow: none;
        font-size:1.1em
        font-family: "Arial Narrow", sans-serif;
      </style>

      <style>
        .leaflet-popup-tip,
        .leaflet-popup-content-wrapper {
            background:#f7f7f7;
            color: black;
            font-size:1.3em
            }
            
      </style>

    <script src="{% static 'bower_components/leaflet-ajax/dist/leaflet.ajax.min.js' %}"></script>
    <script src="{% static 'bower_components/spin.js/spin.min.js' %}"></script>
    <script src="{% static 'bower_components/leaflet-spin/leaflet.spin.js' %}"></script>

</head>
<body>

    <script type="text/javascript">

    var vis = {}

    {%for site in sites.all%}
        vis["{{site.site_code}}"] = "{{site.current_vis}}";
    {%endfor%}
    
    var updated = {}

    {%for site in sites.all%}
    updated["{{site.site_code}}"] = "{{site.last_updated}}";
    {%endfor%}


    function geojsonMarkerOptions(feature) {
        return {
        radius: 16,
        fillColor: getColor(vis[feature.properties.pk.toString()]),
        color: "#000",
        weight: 0,
        opacity: 1,
        fillOpacity: 1
                   
    };
    }

    function getColor(v) {
    return v > 19.9 ? '#0275d8' :
           v > 9.9  ? '#5cb85c' :
           v > 4.9  ? '#f0ad4e' :
           v > 0.1  ? '#d9534f' :
                     '#868e96'  ;
    }

        function map_init_basic (map, options) {
              var geojsonSiteLayer = new L.GeoJSON.AJAX("{% url 'sites' %}", {
            pointToLayer: function (feature, latlng) {
             return L.circleMarker(latlng, geojsonMarkerOptions(feature));
         },
    onEachFeature: function(feature, layer) {

        var label = L.tooltip({
            permanent: true,
            direction: 'center',
            className: 'label'
        })
        .setContent(feature.properties.pk.toString())
        .setLatLng(layer.getLatLng());
        label.addTo(map);
        
        var text = L.popup({
            direction: 'right',
            className: 'text',
            closeOnClick: true,
        })
        .setContent("<a href=" + feature.properties.pk.toString() + "> <b>" + feature.properties.site_name.toString() + "</b></a> <br /> visibility: "+ vis[feature.properties.pk.toString()] + "m<br />" + updated[feature.properties.pk.toString()])
        .setLatLng(layer.getLatLng());
        layer.bindPopup(text);
    
    }
}).addTo(map);
          }
     </script>
     
    {% leaflet_map "map" callback="window.map_init_basic" %}
</body>


{% endblock %}

